<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culinary Bubble Chart</title>

    <!-- Include D3.js directly from CDN (version 6) -->
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <!-- Google Open Sans Font -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800" rel="stylesheet" type="text/css">

    <style>
        body {
            margin: 0;
            background-color: #FAFAFA;
            font-family: 'Open Sans', sans-serif;
            padding: 30px;
            overflow-x: hidden;
            color: #444;
        }

        .section-heading {
            text-align: center;
            margin-bottom: 40px;
        }

        .section-heading h3 {
            font-size: 16px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .section-heading h2 {
            font-size: 32px;
            margin: 0 0 15px;
            color: #333;
            font-weight: 700;
        }

        .section-heading p {
            color: #666;
            font-size: 17px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .visualization-container {
            display: flex;
            flex-direction: row;
            max-width: 1100px;
            width: 1100px;
            margin: 0 auto;
            overflow: visible;
            align-items: flex-start;
            padding-left: 0;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }

        #legend-container {
            width: 220px;
            min-width: 220px;
            margin-right: 60px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            align-self: flex-start;
            margin-left: -80px;
            border: 1px solid #f0f0f0;
        }

        .legend-title {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 17px;
            font-weight: bold;
            font-family: 'Open Sans', sans-serif;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .legend-section {
            margin-bottom: 25px;
        }

        .legend-subtitle {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
            border-left: 3px solid #ddd;
            padding-left: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .legend-item:hover {
            background: #f9f9f9;
        }

        .color-box {
            width: 22px;
            height: 22px;
            margin-right: 12px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .border-sample {
            width: 26px;
            height: 26px;
            margin-right: 12px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .border-solid {
            border: 2px solid #333;
        }

        .border-dashed {
            border: 2px dashed #333;
        }

        .border-thick {
            border-width: 1.8px;
        }

        .border-thin {
            border-width: 1px;
        }

        #bubble-container {
            flex-grow: 1;
            width: 900px;
            height: 850px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 30px;
            position: relative;
        }

        #tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            color: #333;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Open Sans', sans-serif;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            max-width: 280px;
            line-height: 1.5em;
            opacity: 0;
            border: none;
            z-index: 9999;
        }

        #tooltip strong {
            color: #111;
            font-weight: 600;
        }

        .label {
            font-family: 'Open Sans', sans-serif;
            text-anchor: middle;
            pointer-events: none;
            fill: white;
            font-weight: 600;
        }

        .node {
            stroke: #fff;
            stroke-width: 1.5px;
        }
    </style>
</head>

<body>
    <section>
        <div class="section-heading">
            <h3>EXPLORE</h3>
            <h2>Global Ingredients Hierarchy</h2>
            <p>Visualize the most used ingredients by region and culinary category.
                Click on bubbles to explore in detail.</p>
        </div>

        <div class="visualization-container">
            <!-- Legend container on the left -->
            <div id="legend-container">
                <h3 class="legend-title">Visualization Guide</h3>
                <div id="legend-items"></div>
            </div>

            <!-- Bubble chart on the right -->
            <div id="bubble-container"></div>
        </div>
        <div id="tooltip"></div>
    </section>

    <script>
        // Wait for DOM to fully load
        document.addEventListener("DOMContentLoaded", function () {
            // Paleta de cores claras para categorias
            // This brightColors object is no longer directly used for bubble colors, 
            // but could be kept if other parts of the page reference it, or removed if not.
            // For now, we'll leave it commented out or remove it if it's confirmed unused.
            /*
            const brightColors = {
                "Additive": "#FF9E80",      // Laranja claro
                "Bakery": "#FFECB3",        // Amarelo claro
                "Beverage": "#90CAF9",      // Azul claro
                "Cereal": "#FFD54F",        // Amarelo médio
                "Dairy": "#E1F5FE",         // Azul muito claro
                "Flower": "#F8BBD0",        // Rosa claro
                "Herb": "#A5D6A7",          // Verde claro
                "Meat": "#EF9A9A",          // Vermelho claro
                "Nuts & Seed": "#FFCC80",   // Laranja claro
                "Plant": "#81C784",         // Verde médio
                "Spice": "#FF8A65",         // Laranja médio
                "Vegetable": "#AED581"      // Verde-amarelado claro
            };
            */

            // Culinary data directly in code
            const data = {
                "name": "Cuisine",
                "children": [
                    {
                        "name": "Africa",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 365 },
                                    { "name": "water", "value": 241 }
                                ]
                            },
                            {
                                "name": "Herb",
                                "children": [
                                    { "name": "garlic", "value": 334 }
                                ]
                            },
                            {
                                "name": "Meat",
                                "children": [
                                    { "name": "chicken", "value": 234 }
                                ]
                            },
                            {
                                "name": "Plant",
                                "children": [
                                    { "name": "olive", "value": 461 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "cinnamon", "value": 209 },
                                    { "name": "cumin", "value": 264 },
                                    { "name": "pepper", "value": 351 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 341 },
                                    { "name": "tomato", "value": 182 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "Australia & NZ",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 117 },
                                    { "name": "sugar", "value": 152 },
                                    { "name": "water", "value": 156 }
                                ]
                            },
                            {
                                "name": "Dairy",
                                "children": [
                                    { "name": "butter", "value": 115 }
                                ]
                            },
                            {
                                "name": "Herb",
                                "children": [
                                    { "name": "garlic", "value": 106 }
                                ]
                            },
                            {
                                "name": "Plant",
                                "children": [
                                    { "name": "olive", "value": 105 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "pepper", "value": 171 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 184 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "British Isles",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 276 },
                                    { "name": "sugar", "value": 280 },
                                    { "name": "water", "value": 165 }
                                ]
                            },
                            {
                                "name": "Dairy",
                                "children": [
                                    { "name": "butter", "value": 268 }
                                ]
                            },
                            {
                                "name": "Herb",
                                "children": [
                                    { "name": "garlic", "value": 156 }
                                ]
                            },
                            {
                                "name": "Plant",
                                "children": [
                                    { "name": "olive", "value": 157 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "pepper", "value": 247 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 263 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "China",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 435 },
                                    { "name": "sugar", "value": 477 },
                                    { "name": "water", "value": 392 },
                                    { "name": "soy sauce", "value": 707 },
                                    { "name": "vegetable oil", "value": 353 }
                                ]
                            },
                            {
                                "name": "Cereal",
                                "children": [
                                    { "name": "cornstarch", "value": 314 }
                                ]
                            },
                            {
                                "name": "Meat",
                                "children": [
                                    { "name": "chicken", "value": 373 }
                                ]
                            },
                            {
                                "name": "Nuts & Seed",
                                "children": [
                                    { "name": "sesame", "value": 497 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "ginger", "value": 532 },
                                    { "name": "pepper", "value": 521 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "garlic", "value": 526 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "France",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 314 },
                                    { "name": "sugar", "value": 270 },
                                    { "name": "water", "value": 210 }
                                ]
                            },
                            {
                                "name": "Dairy",
                                "children": [
                                    { "name": "butter", "value": 277 }
                                ]
                            },
                            {
                                "name": "Herb",
                                "children": [
                                    { "name": "garlic", "value": 206 }
                                ]
                            },
                            {
                                "name": "Plant",
                                "children": [
                                    { "name": "olive", "value": 228 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "pepper", "value": 236 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 232 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "India",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 1242 },
                                    { "name": "sugar", "value": 1060 },
                                    { "name": "water", "value": 1018 }
                                ]
                            },
                            {
                                "name": "Meat",
                                "children": [
                                    { "name": "chicken", "value": 568 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "cumin", "value": 549 },
                                    { "name": "garlic", "value": 540 },
                                    { "name": "pepper", "value": 492 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 593 },
                                    { "name": "tomato", "value": 444 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "Italy",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 623 },
                                    { "name": "sugar", "value": 381 },
                                    { "name": "water", "value": 363 }
                                ]
                            },
                            {
                                "name": "Dairy",
                                "children": [
                                    { "name": "butter", "value": 289 }
                                ]
                            },
                            {
                                "name": "Herb",
                                "children": [
                                    { "name": "garlic", "value": 373 }
                                ]
                            },
                            {
                                "name": "Plant",
                                "children": [
                                    { "name": "olive", "value": 349 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "pepper", "value": 362 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 331 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "Japan",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 214 },
                                    { "name": "sugar", "value": 194 },
                                    { "name": "water", "value": 170 }
                                ]
                            },
                            {
                                "name": "Meat",
                                "children": [
                                    { "name": "chicken", "value": 149 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "garlic", "value": 129 },
                                    { "name": "pepper", "value": 135 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 133 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "Korea",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 276 },
                                    { "name": "sugar", "value": 272 },
                                    { "name": "water", "value": 200 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "garlic", "value": 245 },
                                    { "name": "pepper", "value": 210 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 227 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "Middle East",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 632 },
                                    { "name": "sugar", "value": 237 },
                                    { "name": "water", "value": 418 }
                                ]
                            },
                            {
                                "name": "Beverage",
                                "children": [
                                    { "name": "lemon juice", "value": 326 }
                                ]
                            },
                            {
                                "name": "Herb",
                                "children": [
                                    { "name": "parsley", "value": 294 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "cumin", "value": 264 },
                                    { "name": "garlic", "value": 553 },
                                    { "name": "pepper", "value": 521 }
                                ]
                            },
                            {
                                "name": "Plant",
                                "children": [
                                    { "name": "olive", "value": 623 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 420 }
                                ]
                            }
                        ]
                    },
                    {
                        "name": "USA",
                        "children": [
                            {
                                "name": "Additive",
                                "children": [
                                    { "name": "salt", "value": 8280 },
                                    { "name": "sugar", "value": 7916 },
                                    { "name": "water", "value": 3490 }
                                ]
                            },
                            {
                                "name": "Bakery",
                                "children": [
                                    { "name": "flour", "value": 4047 }
                                ]
                            },
                            {
                                "name": "Dairy",
                                "children": [
                                    { "name": "butter", "value": 6831 }
                                ]
                            },
                            {
                                "name": "Herb",
                                "children": [
                                    { "name": "garlic", "value": 5235 }
                                ]
                            },
                            {
                                "name": "Meat",
                                "children": [
                                    { "name": "egg", "value": 4748 }
                                ]
                            },
                            {
                                "name": "Plant",
                                "children": [
                                    { "name": "olive", "value": 4668 }
                                ]
                            },
                            {
                                "name": "Spice",
                                "children": [
                                    { "name": "pepper", "value": 7611 }
                                ]
                            },
                            {
                                "name": "Vegetable",
                                "children": [
                                    { "name": "onion", "value": 5188 }
                                ]
                            }
                        ]
                    }
                ]
            };

            // Initialize the visualization
            createBubbleChart(data);

            function createBubbleChart(data) {
                // Configurações e dimensões
                const width = 850;
                const height = 850;
                const margin = 60;

                // Cores para regiões - restore original colors
                const regionColors = {
                    "Africa": "#E53935",         // Vermelho
                    "Australia & NZ": "#FF7043", // Laranja
                    "British Isles": "#FFA726",  // Laranja-amarelado
                    "China": "#FFD54F",          // Amarelo
                    "France": "#66BB6A",         // Verde
                    "India": "#26A69A",          // Verde-azulado
                    "Italy": "#42A5F5",          // Azul
                    "Japan": "#5C6BC0",          // Índigo
                    "Korea": "#7E57C2",          // Violeta
                    "Middle East": "#AB47BC",    // Roxo
                    "USA": "#EC407A"             // Magenta
                };

                // Define category colors for the legend display
                const categoryColors = {
                    "Additive": "#ffab91",    // Light orange
                    "Bakery": "#fff59d",      // Light yellow
                    "Beverage": "#b3e5fc",    // Light blue
                    "Cereal": "#ffe082",      // Light orange-yellow
                    "Dairy": "#e1f5fe",       // Very light blue
                    "Flower": "#f8bbd0",      // Light pink
                    "Herb": "#a5d6a7",        // Light green
                    "Meat": "#ffab91",        // Light red-orange
                    "Nuts & Seed": "#ffe0b2", // Light beige
                    "Plant": "#c5e1a5",       // Light green
                    "Spice": "#ffccbc",       // Light salmon
                    "Vegetable": "#c8e6c9"    // Light green
                };

                // Update Legend to completely match visualization elements
                const legendContainer = d3.select("#legend-items");
                legendContainer.html(""); // Clear existing legend items

                // Change legend title
                d3.select("#legend-container .legend-title").text("Visualization Guide");

                // 1. Create Hierarchy Section
                const hierarchySection = legendContainer.append("div")
                    .attr("class", "legend-section");

                hierarchySection.append("div")
                    .attr("class", "legend-subtitle")
                    .text("Bubble Types");

                // Region item
                const regionItem = hierarchySection.append("div")
                    .attr("class", "legend-item");

                regionItem.append("div")
                    .attr("class", "border-sample")
                    .style("background-color", "#ddd")
                    .style("border", "none");

                regionItem.append("span")
                    .style("font-weight", "500")
                    .text("Region");

                // Category item
                const categoryItem = hierarchySection.append("div")
                    .attr("class", "legend-item");

                categoryItem.append("div")
                    .attr("class", "border-sample border-solid border-thick")
                    .style("background-color", "#e8e8e8");

                categoryItem.append("span")
                    .style("font-weight", "500")
                    .text("Category");

                // Ingredient item
                const ingredientItem = hierarchySection.append("div")
                    .attr("class", "legend-item");

                ingredientItem.append("div")
                    .attr("class", "border-sample border-dashed border-thin")
                    .style("background-color", "#f2f2f2");

                ingredientItem.append("span")
                    .style("font-weight", "500")
                    .text("Ingredient");

                // 2. Create Colors Section
                const colorsSection = legendContainer.append("div")
                    .attr("class", "legend-section");

                colorsSection.append("div")
                    .attr("class", "legend-subtitle")
                    .text("Regions");

                // Process regions in alphabetical order
                Object.entries(regionColors)
                    .sort((a, b) => a[0].localeCompare(b[0])) // Sort alphabetically by region name
                    .forEach(([name, baseColor]) => {
                        // Get the actual color used in the visualization for this region
                        const actualColor = d3.rgb(baseColor).darker(0.7).toString();

                        const item = colorsSection.append("div")
                            .attr("class", "legend-item");

                        item.append("div")
                            .attr("class", "color-box")
                            .style("background-color", actualColor);

                        item.append("span")
                            .style("font-size", "13px")
                            .style("font-weight", "500")
                            .text(name);
                    });

                // Criar o SVG - simplified container structure
                const svg = d3.select("#bubble-container")
                    .append("svg")
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .attr("viewBox", `0 0 ${width} ${height}`)
                    .attr("preserveAspectRatio", "xMidYMid meet")
                    .style("display", "block")
                    .style("margin", "0 auto")
                    .style("cursor", "pointer")
                    .style("overflow", "visible");

                // Define drop shadow filter for root node
                const defs = svg.append("defs");
                const filter = defs.append("filter")
                    .attr("id", "drop-shadow")
                    .attr("height", "130%");

                filter.append("feGaussianBlur")
                    .attr("in", "SourceAlpha")
                    .attr("stdDeviation", 4)
                    .attr("result", "blur");

                filter.append("feOffset")
                    .attr("in", "blur")
                    .attr("dx", 2)
                    .attr("dy", 2)
                    .attr("result", "offsetBlur");

                const feComponentTransfer = filter.append("feComponentTransfer")
                    .attr("in", "offsetBlur")
                    .attr("result", "offsetBlur");

                feComponentTransfer.append("feFuncA")
                    .attr("type", "linear")
                    .attr("slope", 0.3);

                const feMerge = filter.append("feMerge");
                feMerge.append("feMergeNode")
                    .attr("in", "offsetBlur");
                feMerge.append("feMergeNode")
                    .attr("in", "SourceGraphic");

                // Centralize o gráfico
                const g = svg.append("g")
                    .attr("transform", `translate(${width / 2}, ${height / 2})`);

                // Preparar dados hierárquicos
                const root = d3.hierarchy(data)
                    .sum(d => d.value)
                    .sort((a, b) => b.value - a.value);

                // Layout do pack
                const pack = d3.pack()
                    .size([width - margin * 2, height - margin * 2])
                    .padding(15); // Increased padding for better spacing

                // Processar nós
                pack(root);

                // Make ingredient bubbles larger in non-USA regions
                root.descendants().forEach(node => {
                    // Only target ingredient nodes (depth 3) that are NOT in USA
                    if (node.depth === 3 &&
                        node.parent && node.parent.parent &&
                        node.parent.parent.data.name !== "USA") {

                        // Make non-USA ingredients larger
                        node.r = node.r * 1.25; // 25% larger
                    }
                });

                // Find USA node and move it to the center
                const usaNode = root.descendants().find(d => d.data.name === "USA" && d.depth === 1);

                // Variável para manter o controle do nó atual em foco
                let focus = root;
                let view;

                // Helper function to get node fill color
                function getNodeFillColor(d, currentFocusNode) {
                    if (d.depth === 0) return "white"; // Root is pure white

                    let ancestralRegion = d;
                    while (ancestralRegion.depth > 1 && ancestralRegion.parent) {
                        ancestralRegion = ancestralRegion.parent;
                    }

                    const baseColorString = regionColors[ancestralRegion.data.name] || "#CCCCCC"; // Default gray if region not in map

                    if (d.depth === 1) { // Region
                        return d3.rgb(baseColorString).darker(0.7).toString(); // Darker for regions
                    } else if (d.depth === 2) { // Category
                        return baseColorString; // Original color for categories
                    } else if (d.depth === 3) { // Ingredient
                        return d3.rgb(baseColorString).brighter(0.7).toString(); // Lighter for ingredients
                    }

                    return "#e0e0e0"; // Fallback
                }

                // Helper function to get node stroke color
                function getNodeStrokeColor(d, currentFocusNode) {
                    if (d.depth === 0) { // Root node
                        return "#000000"; // Black border for root node
                    }
                    if (d === currentFocusNode && d.depth > 0) { // If focused and not root
                        return "#000000"; // Black border for focused node
                    }
                    return "#fff"; // Default white border for non-focused, non-root nodes
                }

                // Enhanced tooltip with region information
                const tooltip = d3.select("#tooltip");

                // Criar círculos para cada nó
                const circle = g.selectAll("circle")
                    .data(root.descendants())
                    .join("circle")
                    .attr("class", d => d.children ? "node" : "node node--leaf")
                    .attr("fill", d => getNodeFillColor(d, focus))
                    .attr("opacity", 0.95)
                    .attr("stroke", d => getNodeStrokeColor(d, focus))
                    .attr("stroke-width", d => {
                        if (d.depth === 0) return 2.5; // Root node gets a thicker border
                        if (d.depth === 1) return 1.5; // Regiões
                        if (d.depth === 2) return 1.8; // Categorias - reduced from 2.5 to 1.8
                        if (d.depth === 3) return 1; // Ingredientes - reduced from 1.5 to 1
                        return 1.5;
                    })
                    .attr("stroke-dasharray", d => {
                        if (d.depth === 3) return "4,2"; // Ingredientes (tracejada)
                        return "none"; // Regiões e Categorias (sólida)
                    })
                    // Add shadow filter to root node
                    .attr("filter", d => d.depth === 0 ? "url(#drop-shadow)" : "none")
                    .on("mouseover", function (event, d) {
                        let content = "";

                        if (d.depth === 0) {
                            content = `<strong style="font-size:15px">Global Culinary Data</strong><br/>
                                      <span style="color:#555">Total ingredients: ${d.value.toLocaleString()}</span>`;
                        } else if (d.depth === 1) {
                            content = `<strong style="font-size:15px">${d.data.name}</strong><br/>
                                      <span style="color:#555">Total usage: ${d.value.toLocaleString()}</span>`;
                        } else if (d.depth === 2) {
                            content = `<strong style="font-size:15px">${d.data.name}</strong><br/>
                                      <span style="color:#555">Region: ${d.parent.data.name}<br/>
                                      Total usage: ${d.value.toLocaleString()}</span>`;
                        } else if (d.depth === 3) {
                            content = `<strong style="font-size:15px">${d.data.name}</strong><br/>
                                      <span style="color:#555">Category: ${d.parent.data.name}<br/>
                                      Region: ${d.parent.parent.data.name}<br/>
                                      Usage count: ${d.data.value.toLocaleString()}</span>`;
                        }

                        d3.select("#tooltip")
                            .html(content)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 15) + "px")
                            .style("opacity", 1);

                        // Highlight the current bubble with more noticeable stroke-width increase
                        d3.select(this)
                            .style("opacity", 1)
                            .style("stroke-width", function () {
                                if (d.depth === 0) return 3.5;
                                if (d.depth === 1) return 2.5;
                                if (d.depth === 2) return 3.5; // Increased for more contrast
                                if (d.depth === 3) return 2.5; // Increased for more contrast
                                return 2.5;
                            });
                    })
                    .on("mouseout", function () {
                        d3.select("#tooltip").style("opacity", 0);
                        d3.select(this)
                            .style("opacity", 0.95)
                            .style("stroke-width", d => {
                                if (d.depth === 0) return 2.5;
                                if (d.depth === 1) return 1.5;
                                if (d.depth === 2) return 1.8; // Match the reduced value from above
                                if (d.depth === 3) return 1; // Match the reduced value from above
                                return 1.5;
                            });
                    })
                    .on("click", (event, d) => {
                        if (focus !== d) {
                            zoom(d);
                            event.stopPropagation();
                        }
                    });

                // Adicionar grupos de rótulos (apenas para Categorias e Ingredientes)
                const labelGroup = g.selectAll(".label-group")
                    // Filtrar para incluir apenas nós de profundidade > 1 (Categorias e Ingredientes) com nome
                    .data(root.descendants().filter(d => d.data.name && d.depth >= 1)) // Include Regions (depth 1)
                    .join("g")
                    .attr("class", "label-group")
                    .style("fill-opacity", dLabel => { // Updated visibility logic
                        if (focus === root && dLabel.depth === 1) return 1; // Region labels when root is focused
                        if (dLabel.parent === focus && dLabel.depth > 1) return 1; // Category/Ingredient labels
                        return 0;
                    })
                    .style("display", dLabel => { // Updated visibility logic
                        if (focus === root && dLabel.depth === 1) return "inline";
                        if (dLabel.parent === focus && dLabel.depth > 1) return "inline";
                        return "none";
                    })
                    .attr("pointer-events", "none");

                labelGroup.each(function (dNode) {
                    const group = d3.select(this);
                    const name = dNode.data.name;

                    let fontSize, fontWeight, fillColor, yPosition, dominantBaseline;

                    if (dNode.depth === 1) { // Region labels
                        fontSize = "11px";
                        fontWeight = "600"; // Make region names bold
                        fillColor = "#333"; // Dark color for readability above bubble
                        yPosition = -dNode.r - 4; // Position above the bubble (unscaled radius)
                        dominantBaseline = "text-after-edge"; // Bottom of text aligns with yPosition
                    } else { // Category (depth 2) and Ingredient (depth 3) labels
                        fontSize = dNode.depth === 2 ? "12px" : "10px";
                        fontWeight = dNode.depth === 2 ? "600" : "normal";

                        // Check if this node is inside a yellow/bright region and needs dark text
                        const regionName = dNode.depth === 2
                            ? dNode.parent.data.name
                            : dNode.parent.parent.data.name;

                        // Use black text ONLY for very light yellow regions
                        if (regionName === "China") {
                            fillColor = "#000000"; // Black text
                        } else {
                            fillColor = "white"; // White text for all other regions
                        }

                        yPosition = 0; // Centered
                        dominantBaseline = "middle";
                    }

                    // Append the text element first
                    const textElement = group.append("text")
                        .attr("class", "label")
                        .attr("y", yPosition)
                        .style("font-size", fontSize)
                        .style("font-weight", fontWeight)
                        .style("fill", fillColor)
                        .style("dominant-baseline", dominantBaseline)
                        .text(name);

                    // If it's a Region label, add a background rectangle
                    if (dNode.depth === 1) {
                        const textNode = textElement.node();
                        if (textNode) {
                            const bbox = textNode.getBBox();
                            const padding = 3;

                            group.insert("rect", "text.label") // Insert rect *before* the text element
                                .attr("class", "label-background")
                                .attr("x", bbox.x - padding)
                                .attr("y", bbox.y - padding)
                                .attr("width", bbox.width + padding * 2)
                                .attr("height", bbox.height + padding * 2)
                                .attr("rx", 3) // Rounded corners
                                .attr("ry", 3)
                                .style("fill", "white") // Changed to pure white
                                .style("stroke", "#cccccc")
                                .style("stroke-width", "0.5px");
                        }
                    }
                });

                // Remove title display at the top of the SVG to prevent overlap
                const regionFocusTitle = svg.append("text")
                    .attr("id", "region-focus-title")
                    .attr("x", width / 2)
                    .attr("y", 30)
                    .attr("text-anchor", "middle")
                    .style("font-size", "20px")
                    .style("font-weight", "bold")
                    .style("fill", "#333")
                    .style("opacity", 0)
                    .style("display", "none"); // Hide entirely

                // Adicionar evento de clique ao SVG para voltar (zoom out para o root)
                svg.on("click", () => zoom(root));

                // Inicialização da visualização
                zoomTo([root.x, root.y, root.r * 2]);

                // Função de zoom atualizada
                function zoom(dFocus) {
                    focus = dFocus;

                    const transition = svg.transition()
                        .duration(750)
                        .tween("zoom", () => {
                            const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);
                            return t => zoomTo(i(t));
                        });

                    // Update circle fills and strokes based on new focus
                    circle.transition(transition)
                        .attr("fill", d => getNodeFillColor(d, focus))
                        .attr("stroke", d => getNodeStrokeColor(d, focus));

                    // Controlar visibilidade dos grupos de rótulos (Categorias e Ingredientes)
                    labelGroup
                        .transition(transition)
                        .style("fill-opacity", dLabel => {
                            if (focus === root && dLabel.depth === 1) return 1;
                            if (dLabel.parent === focus && dLabel.depth > 1) return 1;
                            return 0;
                        })
                        .on("start", function (dLabel) {
                            if ((focus === root && dLabel.depth === 1) || (dLabel.parent === focus && dLabel.depth > 1)) {
                                this.style.display = "inline";
                            }
                        })
                        .on("end", function (dLabel) {
                            if (!((focus === root && dLabel.depth === 1) || (dLabel.parent === focus && dLabel.depth > 1))) {
                                this.style.display = "none";
                            }
                        });

                    // Atualizar e mostrar/ocultar o título da região focada (Nível 1)
                    if (focus.depth === 1) { // Se o foco é uma Região
                        regionFocusTitle
                            .text(focus.data.name)
                            .transition(transition)
                            .style("opacity", 1);
                    } else { // Se o foco não é uma Região (Raiz, Categoria, Ingrediente)
                        regionFocusTitle
                            .transition(transition)
                            .style("opacity", 0);
                    }
                }

                // Function to apply zoom and transform elements
                function zoomTo(v) {
                    const k = Math.min(width, height) / v[2];
                    view = v;

                    // Transform circles
                    circle.attr("transform", d => `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`);
                    circle.attr("r", d => d.r * k);

                    // Transform label groups
                    labelGroup.attr("transform", d => `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`);
                }
            }
        });
    </script>
</body>

</html>